name: UI Tests

on:
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  ui-tests:
    name: Playwright UI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        working-directory: web-app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: web-app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run Playwright tests
        id: tests
        continue-on-error: true
        run: npx playwright test

      # Upload the full HTML report (includes embedded screenshots and traces)
      - name: Upload Playwright HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: web-app/playwright-report/
          retention-days: 30

      # Upload raw screenshots as a separate artifact for easy browsing
      - name: Upload screenshots artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-screenshots
          path: web-app/test-results/**/*.png
          if-no-files-found: ignore
          retention-days: 30

      # Collect screenshot filenames for the PR comment
      - name: Collect screenshot info
        if: always()
        id: screenshots
        working-directory: web-app
        run: |
          count=$(find test-results -name '*.png' 2>/dev/null | wc -l)
          echo "count=$count" >> "$GITHUB_OUTPUT"

      # Post screenshots inline on the PR using a dedicated branch for image hosting
      - name: Post screenshots to PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');

            // Find all PNG screenshots in test-results
            let pngs = [];
            try {
              const out = execSync('find web-app/test-results -name "*.png" -type f | sort', { encoding: 'utf8' });
              pngs = out.trim().split('\n').filter(Boolean);
            } catch {
              pngs = [];
            }

            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const testStatus = '${{ steps.tests.outcome }}';
            const statusIcon = testStatus === 'success' ? ':white_check_mark:' : ':x:';

            let body = `## ${statusIcon} UI Test Screenshots\n\n`;
            body += `**Status**: ${testStatus === 'success' ? 'All tests passed' : 'Some tests failed'}\n\n`;

            if (pngs.length > 0) {
              // Upload screenshots to a branch so they can be embedded inline
              // For now, link to the artifacts since it's the most reliable approach
              body += `### Screenshots captured: ${pngs.length}\n\n`;
              body += `<details>\n<summary>Screenshot list (click to expand)</summary>\n\n`;

              for (const png of pngs) {
                const name = path.basename(png, '.png');
                const dir = path.basename(path.dirname(png));
                body += `- \`${dir}/${name}\`\n`;
              }
              body += `\n</details>\n\n`;
              body += `> Download the **test-screenshots** artifact to view all screenshots,\n`;
              body += `> or download **playwright-report** and open \`index.html\` for the full\n`;
              body += `> interactive report with screenshots embedded inline.\n\n`;
            } else {
              body += `_No screenshots were captured._\n\n`;
            }

            body += `:link: [View workflow run](${runUrl})\n`;

            // Find and update existing comment, or create a new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = '## :white_check_mark: UI Test Screenshots';
            const markerFail = '## :x: UI Test Screenshots';
            const existing = comments.find(c =>
              c.body?.startsWith(marker) || c.body?.startsWith(markerFail)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      # Fail the job if tests failed
      - name: Check test results
        if: steps.tests.outcome == 'failure'
        run: exit 1
